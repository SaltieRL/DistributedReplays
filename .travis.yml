sudo: required
dist: xenial
language: python
python:
  - '3.6'
  - '3.7'

services:
- postgresql
- redis-server

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test


install:
- pip install -r requirements.txt
- pip install -r requirements-test.txt
- ls
- cd webapp
- npm install
- cd $TRAVIS_BUILD_DIR

jobs:
  include:
    - stage: lint
      name: "style checks"
      script:
        - chmod 777 .travis/tslint.sh && .travis/tslint.sh
    - stage: test
      name: "server unit tests"
      script:
        - pytest --cov=./
        - bash <(curl -s https://codecov.io/bash) -c -F server
    - stage: test
      name: "react unit tests"
      # we only need to run npm tests for one python version
      python: "3.6"
      script:
        - cd webapp
        - npm test
    - stage: test
      name: "integration tests"
      script:
        - cd $TRAVIS_BUILD_DIR
        - cd webapp
        - npm install
        - npm start &
        - cd $TRAVIS_BUILD_DIR
        - celery -A backend.tasks.celery_tasks.celery worker --pool=solo -l info &
        - python3 RLBotServer.py &
    - stage: deploy
      name: "Deploy"
      python: "3.7"
      after_success:
      - codecov
      - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
      - chmod +x .travis/send.sh
      - ./.travis/send.sh success $WEBHOOK_URL

      after_failure:
        - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
        - chmod +x .travis/send.sh
        - ./.travis/send.sh failure $WEBHOOK_URL
